<!DOCTYPE html>
<html>
<head>
  <title>TTS Listener</title>
  <style>
    body {
      background-color: #555;
      padding-top: 10vh;
    }
    .userlist {
      position: fixed;
      height: 100%;
      overflow: auto;
      word-wrap: break-word;
      right: 0;
      width: 150px;
    }
  </style>
</head>
<body>
  <button id="skip" style="position:fixed;left:0;top:0;right:0;height:10vh">SKIP</button>
  <div id="connection">Click to Connect: <button id="connect">Connect</button></div>
  <div>Status: <span id="status">Disconnected</span></div>
  <ul id="users" class="userlist"></ul>
  <div id="messenger" style="display:none">
    <div id="messages"></div>
  </div>

  <script>
    let residentsSeen = {};
    let users = [];
    let ready = false;
    let socket = null;
    let reconnecting = false;
    if ('speechSynthesis' in window) {
      // Prompt voice loading
      speechSynthesis.getVoices();
    }

    function getSocket() {
      if (reconnecting) return;

      socket = null;
      socket = new WebSocket('wss://wcapp.site.com:9443');

      socket.addEventListener('open', (event) => {
        console.log('WebSocket connection opened:', event);
        document.getElementById('status').innerHTML = 'Connected';
      });

      socket.addEventListener('close', (event) => {
        console.log('WebSocket connection closed:', event);
        document.getElementById('users').innerHTML = '';
        document.getElementById('status').innerHTML = 'Disconnected';
        if (!reconnecting) {
          reconnecting = true;
          setTimeout(attemptReconnect, 1000);
        }
      });

      socket.addEventListener('error', (event) => {
        console.log('WebSocket error:', event);
      });

      socket.addEventListener('message', (event) => {
        const payload = JSON.parse(event.data);
        console.log({ payload })

        if (payload.action === 'skip') {
          skip()
        }

        if (payload.action === 'residents') {
          handleJoinLeave(payload);
        }

        const message = payload.message;
        
        if (message) {
          speak(message);
          const messages = document.getElementById('messages');
          messages.innerHTML = messages.innerHTML + `<p>${message}</p>`;
        }
      });
    }

    function handleJoinLeave(event) {
      document.getElementById('users').innerHTML = event.orderedResidents.map(u => {
        residentsSeen[u] = residentsSeen[u] ? residentsSeen[u]++ : 1;
        return `<li>${u.trim()} (${residentsSeen[u]})</li>`
      }).join('');
    }

    function attemptReconnect() {
      console.log('Attempting reconnection');
      reconnecting = false;
      getSocket();
    }

    function connect() {
      if (socket) return;
      getSocket();
      
      document.getElementById('connection').style = 'display:none';
      document.getElementById('messenger').style = 'display:block';
    }

    document.getElementById('connect').addEventListener('click', connect);

    function speak(text) {
      if ('speechSynthesis' in window) {
        console.log('Attempting to speak:', text);
        try {
          const voices = speechSynthesis.getVoices();
          const randomVoice = Math.floor(Math.random() * voices.length)
          currentUtterance = new SpeechSynthesisUtterance(text);
          currentUtterance.voice = voices[randomVoice];
          currentUtterance.pitch = 1;
          currentUtterance.rate = 1;
          currentUtterance.volume = 2;
          currentUtterance.onstart = () => console.log('Utterance started:', text);
          currentUtterance.onerror = (e) => console.error('Utterance error:', e);
          currentUtterance.onend = () => console.log('Utterance ended:', text);
          window.speechSynthesis.speak(currentUtterance);
        } catch (error) {
          console.log(error);
        }
      } else {
        console.error('Speech synthesis is not supported in this browser.');
      }
    }

    function skip() {
      window.speechSynthesis.cancel();
    }
    
    document.getElementById('skip').addEventListener('click', skip);

  </script>
</body>
</html>